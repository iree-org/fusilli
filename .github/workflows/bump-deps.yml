# Copyright 2026 Advanced Micro Devices, Inc.
#
# Licensed under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

name: Bump Dependencies

on:
  workflow_dispatch:
    inputs:
      branch-name:
        default: "bump-deps/nightly"
        type: string
        description: Branch name for the bump PR
  schedule:
    # Weekdays at 10:00 UTC (02:00 PST / 03:00 PDT)
    - cron: "0 10 * * 1-5"

permissions:
  contents: write
  pull-requests: write

env:
  GIT_BRANCH_NAME: ${{ inputs.branch-name || 'bump-deps/nightly' }}

jobs:

  check-for-existing-branch:
    # Only run scheduled workflows on the main repo, not forks.
    if: github.repository == 'iree-org/fusilli' || github.event_name != 'schedule'
    runs-on: ubuntu-24.04
    outputs:
      branch-exists: ${{ steps.check-exists.outputs.branch-exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check for existing bump branch
        id: check-exists
        run: |
          BRANCH_EXISTS=$(git ls-remote --heads origin ${{ env.GIT_BRANCH_NAME }} | wc -l)
          echo "branch-exists=${BRANCH_EXISTS}" >> "${GITHUB_OUTPUT}"
          if [[ ${BRANCH_EXISTS} == 1 ]]; then
            echo "Skipping: branch \`${{ env.GIT_BRANCH_NAME }}\` already exists." \
              >> "${GITHUB_STEP_SUMMARY}"
          fi

  bump-deps:
    needs: check-for-existing-branch
    if: needs.check-for-existing-branch.outputs.branch-exists == '0'
    runs-on: ubuntu-24.04
    defaults:
      run:
        shell: bash --noprofile --norc -exo pipefail {0}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.11"

      # Runs version discovery and updates version.json. Sets CURRENT_*
      # and LATEST_* environment variables via GITHUB_ENV.
      - name: Bump dependency versions
        run: python3 build_tools/scripts/bump_deps.py
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Generate GitHub App token
        if: |
          env.CURRENT_IREE_VERSION != env.LATEST_IREE_VERSION ||
          env.CURRENT_THEROCK_VERSION != env.LATEST_THEROCK_VERSION
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: generate-token
        with:
          app-id: ${{ secrets.CREATE_PULL_REQUEST_TOKEN_APP_ID }}
          private-key: ${{ secrets.CREATE_PULL_REQUEST_TOKEN_APP_PRIVATE_KEY }}

      - name: Create pull request
        if: |
          env.CURRENT_IREE_VERSION != env.LATEST_IREE_VERSION ||
          env.CURRENT_THEROCK_VERSION != env.LATEST_THEROCK_VERSION
        id: cpr
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          token: ${{ steps.generate-token.outputs.token || github.token }}
          base: main
          branch: ${{ env.GIT_BRANCH_NAME }}
          author: "fusilli-bot[bot] <fusilli-bot[bot]@users.noreply.github.com>"
          signoff: true
          delete-branch: true
          title: "Bump IREE and TheRock to latest nightly"
          commit-message: |
            Bump IREE and TheRock to latest nightly

            IREE: ${{ env.CURRENT_IREE_VERSION }} -> ${{ env.LATEST_IREE_VERSION }}
            TheRock: ${{ env.CURRENT_THEROCK_VERSION }} -> ${{ env.LATEST_THEROCK_VERSION }}
          body: |
            ## Summary
            Automated nightly dependency version bump.

            | Dependency | Old | New |
            |------------|-----|-----|
            | IREE | `${{ env.CURRENT_IREE_VERSION }}` | `${{ env.LATEST_IREE_VERSION }}` |
            | TheRock | `${{ env.CURRENT_THEROCK_VERSION }}` | `${{ env.LATEST_THEROCK_VERSION }}` |

            **IREE changelog**: https://github.com/iree-org/iree/compare/iree-${{ env.CURRENT_IREE_VERSION }}...iree-${{ env.LATEST_IREE_VERSION }}

            Auto-generated by [`bump-deps.yml`](https://github.com/${{ github.repository }}/blob/main/.github/workflows/bump-deps.yml).

      - name: Write summary
        if: steps.cpr.outputs.pull-request-number
        run: |
          echo "### Dependency Bump PR Created" >> "${GITHUB_STEP_SUMMARY}"
          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "PR: ${{ steps.cpr.outputs.pull-request-url }}" >> "${GITHUB_STEP_SUMMARY}"
          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "| Dependency | Old | New |" >> "${GITHUB_STEP_SUMMARY}"
          echo "|------------|-----|-----|" >> "${GITHUB_STEP_SUMMARY}"
          echo "| IREE | \`${CURRENT_IREE_VERSION}\` | \`${LATEST_IREE_VERSION}\` |" >> "${GITHUB_STEP_SUMMARY}"
          echo "| TheRock | \`${CURRENT_THEROCK_VERSION}\` | \`${LATEST_THEROCK_VERSION}\` |" >> "${GITHUB_STEP_SUMMARY}"
